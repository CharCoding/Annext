<!DOCTYPE html>
<html>
<head>
	<title>Annext</title>
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
	<link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/css/materialize.min.css" rel="stylesheet" type="text/css" />
	<link href="favicon.ico" rel="icon" type="image/x-icon" />
	<script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/js/materialize.min.js"></script>
	<script type="text/javascript" src="js/wordgen.min.js"></script>
	<script type="text/javascript" src="graphs.js"></script>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<style type="text/css">
	body {
		position: absolute;
		left: 0;
		right: 0;
		top: 0;
		bottom: 0;
		margin: 0;
		background-color: #000;
		font-family: Roboto, Helvectica, sans-serif;
		overflow: hidden;
	}
	body > div {
		position: absolute;
		left: 0;
		top: 0;
		width: 100%;
		height: 100%;
		margin: 0;
	}
	#game { left: 100%; }
	.display { position: absolute; left: 0; width: 100%; text-align: center; color: #fff; }
	h1.display { top: 0; font-size: 112px !important; font-weight: 300 !important; }
	h4.display { top: 144px; }
	.preloader-wrapper {
		position: absolute;
		left: 50%;
		top: 50%;
		margin-left: -24px;
		margin-top: -64px;
	}
	#games {
		position: absolute;
		left: 20%;
		right: 20%;
		top: 240px;
		overflow-y: auto;
		display: none;
	}
	#x { display: inline-block; transition: transform 200ms; }
	h1.display:hover > #x { transform: rotateY(180deg); }
	#start {
		position: absolute;
		top: 256px;
		left: 0;
		right: 0;
		bottom: 0;
	}
	#join { margin-right: -32px; margin-top: -8px; }
	#credits {
		position: absolute;
		bottom: 0;
		width: 100%;
		text-align: center;
		color: white;
	}
	.input-field input[type=text]:focus + label { color: #E91E63; }
	.input-field input[type=text]:focus {
		border-bottom: 1px solid #E91E63;
		box-shadow: 0 1px 0 0 #E91E63;
	}
	#logo { padding-left: 8px; padding-top: 8px; }
	#action { display: none; }
	.circle { /* Can't believe they don't have this class. Well, here goes browser-compatibility... */
		width: 48px;
		height: 48px;
		text-align: center;
		padding: 0 !important;
		margin: 0 !important;
		border-radius: 50%;
	}
	#leftTabs {
		position: relative;
		display: inline-block;
		left: 0;
		top: 0;
		width: auto;
		overflow-x: visible;
	}
	#leftTabs ul, #leftTabs li {
		height: 64px;
	}
	#leftTabs a {
		height: 64px;
		padding: 8px 24px;
		box-sizing: border-box;
	}
	.tabcontent {
		position: absolute;
		left: 0;
		top: 64px;
		right: 0;
		bottom: 0;
	}
	#map {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
	}
	#c {
		position: absolute;
		left: 0;
		top: 0;
		width: 100%;
		height: 100%;
		background-color: rgb(6, 16, 36);
		background-image: url('images/universe.jpg');
		background-repeat: no-repeat;
		background-size: cover;
		background-position: 0 0;
	}
	#historyGraph {border: 2px solid white;}
	#statsGraph {border: 2px solid white;}
	</style>
	<script type="text/javascript">
	(function(window,document) {
		var prefix = "", _addEventListener, support;
		if ( window.addEventListener ) _addEventListener = "addEventListener"; // detect event model
		else {
			_addEventListener = "attachEvent";
			prefix = "on";
		}
		// detect available wheel event
		support = "onwheel" in document.createElement("div") ? "wheel" : // Modern browsers support "wheel"
			document.onmousewheel !== undefined ? "mousewheel" : // Webkit and IE support at least "mousewheel"
			"DOMMouseScroll"; // let's assume that remaining browsers are older Firefox
		window.addWheelListener = function( elem, callback, useCapture ) {
			_addWheelListener( elem, support, callback, useCapture );
			// handle MozMousePixelScroll in older Firefox
			if( support == "DOMMouseScroll" ) _addWheelListener( elem, "MozMousePixelScroll", callback, useCapture );
		};
		function _addWheelListener( elem, eventName, callback, useCapture ) {
			elem[ _addEventListener ]( prefix + eventName, support == "wheel" ? callback : function( originalEvent ) {
				!originalEvent && ( originalEvent = window.event );
				var event = { // create a normalized event object
					originalEvent: originalEvent, // keep a ref to the original event object
					target: originalEvent.target || originalEvent.srcElement,
					type: "wheel",
					deltaMode: originalEvent.type == "MozMousePixelScroll" ? 0 : 1,
					deltaX: 0,  deltaY: 0,  deltaZ: 0,
					preventDefault: function() {
						originalEvent.preventDefault ?
							originalEvent.preventDefault() :
							originalEvent.returnValue = false;
					}
				};
				if ( support == "mousewheel" ) { // calculate deltaY (and deltaX) according to the event
					event.deltaY = - 1/40 * originalEvent.wheelDelta;
					originalEvent.wheelDeltaX && ( event.deltaX = -1/40 * originalEvent.wheelDeltaX ); // Webkit also support wheelDeltaX
				} else event.deltaY = originalEvent.detail;
				return callback( event ); // it's time to fire the callback
			}, useCapture || false );
		}
	})(window,document);
	function trackTransforms(t){ // Credit goes to http://phrogz.net/tmp/canvas_zoom_to_cursor.html
		let svg = document.createElementNS('http://www.w3.org/2000/svg','svg'), xform = svg.createSVGMatrix(),
		savedTransforms = [], save = t.save, restore = t.restore, scale = t.scale, rotate = t.rotate,
		translate = t.translate, transform = t.transform, setTransform = t.setTransform, pt = svg.createSVGPoint();
		t.getTransform = function(){ return xform; };
		t.save = function(){ savedTransforms.push(xform.translate(0,0)); return save.call(t); };
		t.restore = function(){ xform = savedTransforms.pop(); return restore.call(t); };
		t.scale = function(sx,sy){ xform = xform.scaleNonUniform(sx,sy); return scale.call(t,sx,sy); };
		t.rotate = function(radians){ xform = xform.rotate(radians*180/Math.PI); return rotate.call(t,radians); };
		t.translate = function(dx,dy){ xform = xform.translate(dx,dy); return translate.call(t,dx,dy); };
		t.transform = function(a,b,c,d,e,f){ var m2 = svg.createSVGMatrix(); m2.a=a; m2.b=b; m2.c=c; m2.d=d; m2.e=e; m2.f=f;
			xform = xform.multiply(m2); return transform.call(t,a,b,c,d,e,f); };
		t.setTransform = function(a,b,c,d,e,f){ xform.a = a; xform.b = b; xform.c = c; xform.d = d; xform.e = e;
			xform.f = f; return setTransform.call(t,a,b,c,d,e,f); };
		t.transformedPoint = function(x,y){ pt.x=x; pt.y=y; return pt.matrixTransform(xform.inverse()); }
		t.originalPoint = function(x,y){ pt.x=x; pt.y=y; return pt.matrixTransform(xform); };
	}
	</script>
</head>
<body onkeydown="whichKey(event)">
	<div id="home">
		<h1 class="display">Anne<img id="x" src="./images/x.png" width="69" height="60" alt="x" />t</h1>
		<h4 class="display">Next Level World Domination</h4>
		<div id="start">
			<div class="row">
				<div class="col s2 offset-s3 white-text"><h4 style="text-align: right;">ws://</h4></div>
				<div class="col s1 input-field white-text">
					<input type="text" id="url" class="validate" required="required" placeholder="Server code" maxlength="8" size="8" pattern="^[a-f\d]{8}$" data-error="Invalid code" data-successs="Looks good!" />
				</div>
				<div class="col s2 white-text">
					<h4>.ngrok.io <a id="join" class="btn-floating btn-large waves-effect waves-light pink right"><i class="material-icons">arrow_forward</i></a></h4>
				</div>
			</div>
			<div class="row">
				<div class="col s2 offset-s5 center-align">
					<a href="#" class="btn btn-large waves-effect waves-light indigo white-text">Manual</a>
				</div>
			</div>
		</div>
		<p id="credits">&copy; 2017 Annext by <a class="pink-text" href="http://github.com/CharCoding/" title="GitHub">CharCoding</a>, All Rights Reserved.</p>
		<!-- We might not need this, since all servers are forwarded to ngrok.io -->
		<!--div id="load" class="preloader-wrapper active">
			<div class="spinner-layer spinner-blue">
				<div class="circle-clipper left">
					<div class="circle"></div>
				</div><div class="gap-patch">
					<div class="circle"></div>
				</div><div class="circle-clipper right">
					<div class="circle"></div>
				</div>
			</div>
			<div class="spinner-layer spinner-red">
				<div class="circle-clipper left">
					<div class="circle"></div>
				</div><div class="gap-patch">
					<div class="circle"></div>
				</div><div class="circle-clipper right">
					<div class="circle"></div>
				</div>
			</div>
			<div class="spinner-layer spinner-yellow">
				<div class="circle-clipper left">
					<div class="circle"></div>
				</div><div class="gap-patch">
					<div class="circle"></div>
				</div><div class="circle-clipper right">
					<div class="circle"></div>
				</div>
			</div>
			<div class="spinner-layer spinner-green">
				<div class="circle-clipper left">
					<div class="circle"></div>
				</div><div class="gap-patch">
					<div class="circle"></div>
				</div><div class="circle-clipper right">
					<div class="circle"></div>
				</div>
			</div>
		</div>
		<ul id="games" class="collection with-header">
			<li class="collection-header">
				<h4>Games<a id="createbtn" class="btn-floating waves-effect waves-light indigo secondary-content right-align"><i class="material-icons">add</i></a></h4>
			</li>
			<li class="collection-item avatar">
				<i class="material-icons circle white green-text">public</i>
				<span class="title">AnnexTheWorld</span>
				<p><span class="green-text">3 / 8</span><br />Earth</p>
				<a href="" class="secondary-content"><i class="material-icons medium">keyboard_arrow_right</i></a>
			</li>
			<li class="collection-item avatar">
				<i class="material-icons circle red">lock</i>
				<span class="title">New Imperialism</span>
				<p><span class="green-text">5 / 8</span><br />The World of AMOC</p>
				<a id="privateGame" href="" class="secondary-content"><i class="material-icons medium">keyboard_arrow_right</i></a>
			</li>
			<li class="collection-item avatar">
				<i class="material-icons circle white green-text">public</i>
				<span class="title">World Domination 101</span>
				<p><span class="red-text">8 / 8</span><br />Random Map</p>
				<a href="" class="secondary-content"><i class="material-icons orange-text medium">keyboard_arrow_right</i></a>
			</li>
		</ul>
		<div id="create" class="modal modal-fixed-footer">
			<div class="modal-content">
				<h4>Create Game</h4>
				<div class="row">
					<div class="col s6 input-field">
						<input type="text" id="name" class="validate" required="required" maxlength="24" /><label for="name">Game Name</label>
					</div>
					<div class="col s6 input-field">
						<input type="checkbox" id="private" /><label for="private">Private</label>
					</div>
				</div>
				<div class="row">
					<div class="col s6 input-field">
						<input type="password" id="password" class="validate" required="required" disabled="disabled" /><label for="password">Password</label>
					</div>
					<div class="col s6 input-field">
						<select>
							<option value="1" selected="selected">Earth</option>
							<option value="2">The World of AMOC</option>
							<option value="3">Randomized</option>
						</select>
						<label>Map</label>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<a href="#!" class="modal-action modal-close blue-text waves-effect waves-blue btn-flat">Create</a>
				<a href="#!" class="modal-action modal-close blue-text waves-effect waves-red btn-flat">Cancel</a>
			</div>
		</div-->
	</div>
	<div id="game">
		<nav class="nav">
			<div class="nav-wrapper indigo">
				<div id="leftTabs">
					<ul id="nav-content" class="left tabs tabs-transparent indigo">
        		<li class="tab"><a id="mapButton" href="#map">MAP</a></li>
        		<li class="tab"><a id="historyButton" href="#history">HISTORY</a></li>
        		<li class="tab"><a id="statsButton" href="#stats">STATS</a></li>
        		<li class="tab disabled"><a href="#battle">BATTLE</a></li>
      		</ul>
      	</div>
				<a href="#" class="brand-logo center">
					<!--img id="logo" src="images/x.png" width="46" height="40" alt="x" /-->
					<span id="countryName"></span>
				</a>
				<ul class="right">
					<li><a href="#!"><i class="material-icons left">launch</i>Manual</a></li>
					<li><a href="#!" id="chatBtn"><i class="material-icons right">chat</i>Chat</a></li>
				</ul>
			</div>
		</nav>
		<div id="map" class="col s12 tabcontent">
			<div id="ctxmenu">
				<div id="economymenu">

				</div>
				<div id="militarymenu">

				</div>
			</div>
			<canvas id="c"></canvas>
			<div id="action" class="fixed-action-btn horizontal">
				<a class="btn-floating btn-large pink waves-effect waves-light">
					<i class="large material-icons">add</i>
				</a>
				<ul>
					<li>
						<a id="cityBtn" class="btn-floating blue-grey waves-effect waves-light">
							<i class="material-icons">location_city</i>
						</a>
					</li>
					<li>
						<a id="militaryBtn" class="btn-floating red waves-effect waves-light">
							<i class="material-icons">gps_fixed</i>
						</a>
					</li>
					<li>
						<a id="buildBtn" class="btn-floating yellow darken-1 waves-effect waves-light">
							<i class="material-icons">build</i>
						</a>
					</li>
					<li>
						<a id="tradeBtn" class="btn-floating green waves-effect waves-light">
							<i class="material-icons">attach_money</i>
						</a>
					</li>
				</ul>
			</div>
		</div>
		<div id="history" class="col s12 tabcontent">
			<div class="container">
				<br>
				<center><a id="historyGraphTitle" class="dropdown-button btn pink" data-activates="historyGraphSelector">Development</a></center>
				<ul id='historyGraphSelector' class='dropdown-content indigo-text'> <!--indigo-text class does nothing here, hence the text classes below--->
					<li><a class="indigo-text" >Development</a></li>
					<li><a class="indigo-text" >Population</a></li>
				 <li><a class="indigo-text" >Steel Production</a></li>
				 <li><a class="indigo-text" >Oil Production</a></li>
				 <li><a class="indigo-text" >Air Units</a></li>
				 <li><a class="indigo-text" >Land Units</a></li>
				 <li><a class="indigo-text" >Sea Units</a></li>
				 <li><a class="indigo-text" >Nuclear Weapons</a></li>
			 </ul>
			 <canvas id="historyGraph"></canvas>
			</div>
		</div>
		<div id="stats" class="col s12 tabcontent">
			<br>
			<center><a id="statsTitle" class="dropdown-button btn pink" data-activates="statsSelector">Development</a></center>
			<ul id='statsSelector' class='dropdown-content indigo-text'>
				<li><a class="indigo-text">Development</a></li>
				<li><a class="indigo-text">Population</a></li>
			 <li><a class="indigo-text">Steel Production</a></li>
			 <li><a class="indigo-text">Oil Production</a></li>
			 <li><a class="indigo-text">Air Units</a></li>
			 <li><a class="indigo-text">Land Units</a></li>
			 <li><a class="indigo-text">Sea Units</a></li>
			 <li><a class="indigo-text">Tiles</a></li>
			 <li><a class="indigo-text">Nuclear Weapons</a></li>
		 </ul></center>
		 <br>
		 <div class="row">
			 <div class="col s6">
				 <table id="statsTable" class="highlight white-text">
					 <thead>
						 <tr>
							 <th>Player</th>
							 <th id="statsTableHeading">Development</th>
							 <th id="statsTablePercentHeading">% of World Development</th>
						 </tr>
					 </thead>
					 <tbody id="statBody">
					 </tbody>
				 </table>
			 </div>
			 <div class="col s6">
				 <canvas id="statsGraph"></canvas>
			 </div>
			</div>
		</div>
		<div id="battle" class="col s12 tabcontent">

		</div>
		<!-- Sidenav always hides when blurred, implementing my own -->
		<!--ul id="side-chat" class="side-nav">
			<li>
				<div class="row valign-wrapper">
					<div class="col s9">
						<h4>Chat</h4>
					</div>
					<div class="col s3 valign-wrapper right-align"><a href="#" id="closeChat" class="btn-flat circle waves-effect waves-light gray-text right"><i class="material-icons">arrow_forward</i></a></div>
				</div>
			</li>
			<li><div class="divider"></div></li>
		</ul-->
		<div id="chatbox">
			<div class="row">
				<div class=""></div>
			</div>
		</div>
		<div id="countryModal" class="modal">
			<div class="modal-content">
				<h4>Name of Your Country:</h4>
				<div class="row">
					<div class="col s6 input-field">
						<input id="countryInput" class="validate" type="text" required="required" maxlength="32" pattern="^[A-Za-z][A-Za-z ]+$" data-error="Invalid country name" data-success="Sounds great!" /><label for="country">Country Name:</label>
					</div>
					<div class="col s6">
						<a id="generateName" class="btn waves-effect waves-light pink white-text">GENERATE <i class="material-icons right">refresh</i></a>
					</div>
				</div>
				<div class="row">
					<div class="col s12">Try to come up with a name that doesn't reveal your identity, so that the game can be less personal.<br />A country name can only contain letters and spaces.<br />You CANNOT change the country name once you press CONFIRM.</div>
				</div>
			</div>
			<div class="modal-footer">
				<a href="#!" id="submitName" class="disabled btn modal-action modal-close waves-effect waves-light indigo white-text">CONFIRM</a>
			</div>
		</div>
	</div>
	<script type="text/javascript">
	var player = {
		countryName: "",
		color: "",
		capital: {
			x: 0,
			y: 0,
			z: 0,
			name: "",
			captured: false
		},
		$development: 0,
		$city: 0,
		seaUnits : 0,
		landUnits : 0,
		airUnits : 0,
		units : function() {
			return this.seaUnits + this.landUnits + this.airUnits;
		}
	};
	$(document).ready(function(){
		const countryRegex = /^[a-z]+( ?[a-z]+)+ ?[a-z]$/i;
		$('#countryInput').on('change input',function(){
			let val = $(this).val();
			if(val.length > 3 && val.length < 33 && countryRegex.test(val)) $('#submitName').removeClass('disabled');
			else $('#submitName').addClass('disabled');
		});
		$('#join').on('click',function(){
			$('#home').animate({"left": "-100%"}, 400);
			$('#game').animate({"left": "0"}, 400);
			$('#countryModal').modal({dismissible: false, inDuration: 250, complete: function() {
				if(player.countryName && $('#countryInput').val().trim() == '') return;
				if($('#countryInput').val().trim() == '') player.countryName = word(2,1).capitalize();
				else player.countryName = $('#countryInput').val().capitalize();
				$('#countryName').text(' ' + player.countryName);
				$('#countryModal').remove();
				// TODO: Send country object to server
			}});
			$('#countryModal').modal('open');
			$('#action,#navigator').fadeIn(400);
		});
		//$('#chatBtn').sideNav({menuWidth: 360, edge: 'right', closeOnClick: false});
		$('#closeChat').on('click',function(){
			$('#side-chat').removeClass('fixed').sideNav('hide');
			//$('#chatBtn').sideNav({edge: 'right', closeOnClick: false}).sideNav('hide');
		});
		$('#chatBtn').on('click',function(){
			$('#side-chat').sideNav('show').addClass('fixed');
			//$('#chatBtn').sideNav({edge: 'right', closeOnClick: false});
		});
		$('#generateName').on('click',function(){
			$('#countryInput').val(word(2,1).capitalize());
			$('#submitName').removeClass('disabled');
			Materialize.updateTextFields();
		});
		$('#historyGraphSelector').on('click', function() {
			var type = event.target.innerHTML;
			historyGraphTitle.innerHTML = type;
			//drawGraph(historyGraph.getContext('2d'), getDataSet(type, players), "line", true)
		});
		$('#statsSelector').on('click', function() {
			var type = event.target.innerHTML;
			statsTitle.innerHTML = type;
			statsTableHeading.innerHTML = type;
			statsTablePercentHeading.innerHTML = "% of World " + type;
		});
		Materialize.updateTextFields();
		$(window).on('resize',canvasSize);
		//GRAPH TESTS (remove after functionality for getting player data is in place):
		drawGraph(historyGraph.getContext('2d'), testDataSet, "line", true);
		drawGraph(statsGraph.getContext('2d'), testDataSet, "pie", true);
	});
	function KShortcut(letter, func, description, interpretLetterAsKeycode, altName) {
	  var obj = {
	    keycode : 0,
	    func: func,
	    letter : letter,
	    description: description //does nothing, but useful if a keyboard shortcut list is added to the game UI at some point
	  }
	  if (interpretLetterAsKeycode) { //for arrow keys and other things that can't be typed
	    obj.keycode = letter;
	    obj.letter = altName;
	  } else {
	    for (var i = 1; i < 256; i++) {
	      if (String.fromCharCode(i) == letter.toUpperCase()) {
	        obj.keycode = i;
	      }
	    }
	  }
	  return obj;
	}
	function whichKey(event) {
		for (var i = 0; i < keyboardShortcuts.length; i++) {
	    if (event.keyCode == keyboardShortcuts[i].keycode) {
	      keyboardShortcuts[i].func();
	    }
	  }
	}
	var keyboardShortcuts = [
		KShortcut("1", function(){mapButton.click();}, "move to map"),
		KShortcut("2", function(){historyButton.click();}, "move to history"),
		KShortcut("3", function(){statsButton.click();}, "move to stats")
	];
	function canvasSize(){
		c.width = $('#c').width();
		c.height = $('#c').height();
	}
	canvasSize();
	//var t = c.getContext('2d');
	/* // Code for room joining/creating
	function onWebSocketConnect(){
		$('#load').fadeOut();
		$('#games').slideToggle();
	}
	$(document).ready(function(){
		$('select').material_select();
		$('#load').on('click',onWebSocketConnect);
		$('#createbtn').on('click',function(){
			$('#create').openModal();
		});
		$('#private').on('click',function(){
			var c = $('#private').is(':checked')
			$('#password').prop('disabled', !c);
			if (!c) {
				$('#password').removeClass('valid').removeClass('invalid');
			} else {
				if($('#password').val() == '') $('#password').removeClass('valid').addClass('invalid');
				else $('#password').removeClass('invalid').addClass('valid');
			}
		});
		$('#privateGame').on('click',function(){

		});
		$('#name').on('blur keyup',function(){
			if($('#name').val().trim() == '') $('#name').addClass('invalid');
			else $('#name').removeClass('invalid').addClass('valid');
		});
		$('#password').on('blur keyup',function(){
			if($('#password').val() == '' && $('#private').is(':checked')) $('#password').addClass('invalid');
			else $('#password').removeClass('invalid').addClass('valid');
		});
	});
	//*/
	let width = window.innerWidth, height = window.innerHeight - 64 /*height of top tab*/, keyspressed = [], timer;
	const scaleFactor = 1.04, t = c.getContext('2d'), hgraph = historyGraph.getContext('2d'),
	r = 16, colors = ["#003fcf","#00ff3f","#cfcf00","#7f7f7f"],
	map = new Array(20), mouse = {
		x: width / 2, y: height / 2, dragged: false, dragStart: null
	};
	trackTransforms(t);
	c.width = width; c.height = height;
	historyGraph.width = width / 1.5; historyGraph.height = height / 1.5;
	statsGraph.width = width / 2.5; statsGraph.height = height / 2;
	hgraph.fillStyle = "red";
	hgraph.fillText("NO DATA", historyGraph.width / 2, historyGraph.height / 2);
	t.strokeStyle = "#000";
	t.lineWidth = 1;
	t.translate(width / 2, height / 2);
	t.scale(2, 2);
	let s = 1;
	class Hex {
		constructor(x, y, type){
			this.type = type;
			this.color = colors[type];
			this.x = x;
			this.y = y;
			this.owner = null;
			this.buildings = [];
			this.units = [];
			this.isCapital = false;
			return map[x][y] = this;
		}
		get neighbors(){
			return [ // does this really work?
				map[mod(this.x + 1, 21)][this.y],
				map[mod(this.x + 1, 21)][mod(this.y - 1, 21)],
				map[this.x][mod(this.y - 1, 21)],
				map[mod(this.x - 1, 21)][this.y],
				map[mod(this.x - 1, 21)][mod(this.y + 1, 21)],
				map[this.x][mod(this.y + 1, 21)],
			];
		}
		draw(color){
			let x = (this.x + this.y) * r * 1.5 - 30 * r, y = (this.y - this.x) * r * .866;
			let pt = t.originalPoint(x, y), z = t.getTransform.a, HP = r * z * .75, VP = r * z * .866;
			// zoom, horizontal/vertical padding
			if(pt.x + HP < 0 || pt.x - HP > width || pt.y + VP < 0 || pt.y - VP > height){
				if(pt.x + HP < 0) pt.x = mod(pt.x, 60 * r) + 60 * r;
				else if(pt.x - HP > width) pt.x = mod(pt.x, 60 * r) - 60 * r;
				if(pt.y + VP < 0) pt.y = mod(pt.x, 17.32 * r) + 17.32 * r;
				else if(pt.y - VP > height) pt.y = mod(pt.y, 17.32 * r) - 17.32 * r;
				pt = t.transformedPoint(pt);
				x = pt.x;
				y = pt.y;
				color = "#00ff00"; // this doesn't work
			}
			t.beginPath();
			t.moveTo(x + r, y);
			t.lineTo(x + r / 2, y + r * .866);
			t.lineTo(x - r / 2, y + r * .866);
			t.lineTo(x - r, y);
			t.lineTo(x - r / 2, y - r * .866);
			t.lineTo(x + r / 2, y - r * .866);
			t.closePath();
			if(color == "outline") {
				t.strokeStyle = "#ffffff";
				t.stroke();
			} else {
				t.fillStyle = color || this.color;
				t.fill();
			}
		}
		static round(x, y){
			[x, y] = [(x - 1.732 * y) / 3 / r + 10, (x + 1.732 * y) / 3 / r + 10];
			let z = -x - y, _x = Math.round(x), _y = Math.round(y), _z = Math.round(z),
				dx = Math.abs(x - _x), dy = Math.abs(y - _y), dz = Math.abs(z - _z),
				dm = Math.max(dx, dy, dz);
			if (dm == dx) {
				return map[mod(-_y - _z, 21)][mod(_y, 21)];
			} else if (dm == dy) {
				return map[mod(_x, 21)][mod(-_x - _z, 21)];
			} else if (dm == dz) {
				return map[mod(_x, 21)][mod(_y, 21)];
			} else return {draw:function(){}}; // avoid errors lol
		}
	}
	for(let x = 0; x < 21; x++){
		map[x] = new Array(21);
		for(let y = 0; y < 21; y++){
			new Hex(x, y, 0);
		}
	}
	function mod(a, b){ return a - Math.floor(a / b) * b; }
	c.addEventListener('mousedown',function(evt){
		mouse.x = evt.offsetX || (evt.pageX - c.offsetLeft);
		mouse.y = evt.offsetY || (evt.pageY - c.offsetTop);
		mouse.dragStart = t.transformedPoint(mouse.x, mouse.y);
		mouse.dragged = false;
	},false);
	c.addEventListener('mousemove',function(evt){
		mouse.x = evt.offsetX || (evt.pageX - c.offsetLeft);
		mouse.y = evt.offsetY || (evt.pageY - c.offsetTop);
		mouse.dragged = true;
		if (mouse.dragStart) {
			var pt = t.transformedPoint(mouse.x, mouse.y);
			t.translate(pt.x - mouse.dragStart.x, pt.y - mouse.dragStart.y);
		}
	},false);
	c.addEventListener('mouseup',function(evt){
		mouse.dragStart = null;
		// if (!dragged) zoom(evt.shiftKey ? -1 : 1 );
	},false);
	c.addEventListener('click',function(evt){
		if(player.god == true){
			let pt = t.transformedPoint(mouse.x,mouse.y),
			hex = Hex.round(pt.x, pt.y);
			hex.type++;
			if(hex.type > 3) hex.type = 0;
			hex.color = colors[hex.type];
			_mx++; // hack: force draw() to re-render map
		}
		if(!mouse.dragStart){

		}
	},false);
	c.addEventListener('contextmenu',function(evt){
		evt.preventDefault();
		return false;
	},false);
	window.addEventListener('resize',function(evt){
		c.width = width = window.innerWidth;
		c.height = height = window.innerHeight - 64;
		trackTransforms(t);
		mouse.x = width / 2;
		mouse.y = width / 2;
	});
	function zoom(clicks){
		var pt = t.transformedPoint(mouse.x,mouse.y);
		t.translate(pt.x,pt.y);
		var factor = Math.pow(scaleFactor,clicks), m = t.getTransform();
		if(factor < 1 && m.a <= 1) {
			t.setTransform(1, m.b, m.c, 1, m.e, m.f);
		} else if(factor > 1 && m.a >= 8) {
			t.setTransform(8, m.b, m.c, 8, m.e, m.f);
		} else t.scale(factor,factor);
		t.translate(-pt.x,-pt.y);
	}
	addWheelListener(c,function(evt){
		zoom(Math.min(Math.max(evt.deltaY / 100, -8), 8));
		return evt.preventDefault() && false;
	});
	let interval = 30, now, then = Date.now(), delta, _mx = mouse.x, _my = mouse.y, _mz = t.getTransform().a;
	// FPS controller and input check for optimizations
	function draw(){
		timer = requestAnimationFrame(draw);
		now = Date.now();
		delta = now - then;
		if(delta <= interval) return;
		if(_mx == mouse.x && _my == mouse.y && _mz == t.getTransform().a) return;
		_mx = mouse.x;
		_my = mouse.y;
		_mz = t.getTransform().a;
		then = now - (delta % interval);
		t.save();
		t.setTransform(1,0,0,1,0,0);
		t.clearRect(0, 0, width, height);
		t.restore();
		for(let x = 0; x < 21; x++){
			for(let y = 0; y < 21; y++)
				map[x][y].draw();
		}
		let pt = t.transformedPoint(mouse.x, mouse.y);
		Hex.round(pt.x, pt.y).draw("outline");
		pt = t.transformedPoint(width / 2, height / 2);
		c.style.backgroundPosition = (width / 2 - pt.x) / 20 + 'px ' + (height / 2 - pt.y) / 20 + 'px';
	}
	var prng = {
		m : Math.pow(2, 32), //see https://en.wikipedia.org/wiki/Linear_congruential_generator#Parameters_in_common_use
		a : 1664525,
		c : 1013904223,
		seed : 12,
		next : function() {
			this.seed = (this.a * this.seed + this.c) % this.m;
			return this.seed;
		}
	}
	function seedToMap(s) {
		prng.seed = s;
		var borderLand = 0.4,
		borderDesert = 0.6,
		borderMountain = 0.7,
		levelSizes = [24, 12, 6, 3], //size of (square) level tiles
		levelNumbers = [1000, 1000, 1000, 1000], //number of tiles for each level that will need to be generated to fill map (optimize later)
		levels = [], //values for each level
		levelMultipliers = [0.1, 0.2, 0.3, 0.2, 0.2]; //weights assigned to sum of each level (should add to 1)
		for (let i = 0; i < levelSizes.length; i++) {
			//levelNumbers.push(Math.ceil(Math.pow(24, 2) / Math.pow(levelSizes[i], 2)));
			levels.push(new Array(levelNumbers[i]));
		}
		for (let i = 0; i < levels.length; i++) {
			for (let j = 0; j < levels[i].length; j++) {
				levels[i][j] = prng.next();
			}
		}
		for (let x = 0; x < map.length; x++) {
			for (let y = 0; y < map[x].length; y++) {
				var sum = 0;
				for (let a = 0; a < levelMultipliers.length - 1; a++) {
					sum += (levels[a][Math.floor(x / levelSizes[a]) * levelSizes[a] + Math.floor(y / levelSizes[a])]) * levelMultipliers[a];
				}
				sum += prng.next() * levelMultipliers[levelMultipliers.length - 1];
				if (sum / prng.m > borderMountain) {
					map[x][y].type = 3;
				} else if (sum / prng.m > borderDesert) {
					map[x][y].type = 2;
				} else if (sum / prng.m > borderLand) {
					map[x][y].type = 1;
				} else {
					map[x][y].type = 0; //redundant, but allows for easier console testing since ocean can overwrite land
				}
				map[x][y].sum = sum / prng.m; //debug only - comment out if desired
				map[x][y].color = colors[map[x][y].type];
				// render immediately
				_mx++;
			}
		}
	}
	function exportMap(){ // this allows maps up to 26x26 due to the doubles' 2^53 mantissa limit
		let arr = new Array(21).fill(0);
		for(let x = 0; x < 21; x++){
			for(let y = 0; y < 21; y++){
				arr[x] += map[x][y].type * Math.pow(2, 2*y);
			}
			arr[x] = arr[x].toString(36); // compress via base36
		}
		prompt("Your map:",arr.join());
	}
	function importMap(str){
		let arr = (str || prompt("Enter a map string:")).split(',');
		if(arr.length < 21) return console.log("Something is wrong with this map string");
		for(let x = 0; x < 21; x++){
			arr[x] = parseInt(arr[x], 36);
			for(let y = 0; y < 21; y++){
				map[x][y].color = colors[map[x][y].type = arr[x] / Math.pow(2, 2*y) & 3];
				//hack: & 3 both floors the result (bitwise operator) and modulo the result by 4
			}
		}
	}
	importMap("vkisfod,ewpm2oal,if376btp,ewofggbd,begwwf9x,1hd780k,ieydxy4w,3q64aakw,ihf6a9es,lxcvjbr4,4dulwetd,282dc,in0fdzkl,noi2nuop,imw4jxgl,ipbr4fv9,4ecbzur5,ikvkwfa7,15ft74cpp,zdbmp3qh,12ga122vp");
	// player.god = true; // edit map with this
	draw();
	</script>
</body>
</html>
